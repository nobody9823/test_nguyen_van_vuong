# laravel_jarvis

## Introduction

Build jarvis from laravel with docker-compose

## Usage

laravel_jarvis では Docker の立ち上げ、コマンド実行、Laravel プロジェクトの作成などの多くの操作を C 言語等の煩雑なビルド作業をまとめて 1 つのコマンドで実行できるようにするのに広く使われている make で実行できるように[Makefile](https://github.com/valleyin-dev/laravel_jarvis/blob/main/Makefile)を用意しています。

公式サイト( https://www.gnu.org/software/make/ )から make コマンドを実行する環境をインストールして使用すると楽になるかもしれません。

このリポジトリでは既に Laravel のプロジェクトは作成されてしまっているので必要なライブラリ等だけ composer の install でインストールすれば大丈夫なはずです。

make コマンドがインストールされている場合は以下のコマンドを実行して頂ければ、現在リポジトリに作成されているプロジェクトが localhost で立ち上がるまで完了すると思います。

```bash
$ make init
```

http://localhost

また初めに、既存のマイグレーションファイルを実行するために

```bash
make refresh
```

を実行してください。既にプロジェクトの方で作成されているテーブル構造にローカルのデータベースを統一することができます。

## Tips

Read this Wiki(hove not implemented). <!-- [Wiki](). -->

## Container structure

```bash
├── app
├── web
└── db
```

### app container

- Base image
  - [php](https://hub.docker.com/_/php):7.4-fpm-buster
  - [composer](https://hub.docker.com/_/composer):2.0

### web container

- Base image
  - [nginx](https://hub.docker.com/_/nginx):1.18-alpine
  - [node](https://hub.docker.com/_/node):14.2-alpine

### db container

- Base image
  - [mysql](https://hub.docker.com/_/mysql):8.0

#### Persistent MySQL Storage

By default, the [named volume](https://docs.docker.com/compose/compose-file/#volumes) is mounted, so MySQL data remains even if the container is destroyed.
If you want to delete MySQL data intentionally, execute the following command.

```bash
$ docker-compose down -v && docker-compose up
```

### コミュニケーション

- Slack にファンリターンのワークスペースがあり、質問共有チャンネルでバグ報告や開発においての質問などをする。
- 通知専用チャンネルは本番環境のサーバーエラー通知と GitHub の通知などが送られる。

### ClickUp

Using ClickUp to manage project
See more detail at valleyin wiki

## 開発に使用するもの

- ER図<br>
こちらにテーブルの説明やカラムの内容等を記載しています。<br>
https://ondras.zarovi.cz/sql/demo/?keyword=fanreturn

- メール<br>
ローカル環境でメールの動作を確認する際はこちらのURLでMailLogにアクセスしてください。<br>
http://localhost:8025

- クレジットカードのテスト番号<br>
https://resource-sharing.co.jp/ec-sites-credit-card-test-number/

# 仕様

__最終更新日 : 2022年3月5日__

## 目次
- [概要](#概要)
- [ユーザーの仕様](#ユーザーの仕様)
- [インフルエンサーの仕様](#インフルエンサーの仕様)
- [管理者の仕様](#管理者の仕様)

## 概要

<details>
<summary>本文を展開</summary>

__【ユーザー画面】__<br>
支援募集者（インフルエンサーやライバー等）がライブやイベント、やりたい事を叶える為にファンから資金を募ります。<br>
支援募集者はクラファンプロジェクトを作成し、支援したユーザーに対して返礼品や何らかのお礼をリターンとして設定します。<br>
プロジェクトを作成したら、管理者に申請を出し、審査にて問題なければ一定期間掲載されます。<br>
プロジェクトの募集形式はAll or Nothing か All inを採用しています。<br>
※詳細な仕様は下記 __All or Nothing と All in方式__ で解説しています。<br>

__【管理画面】__<br>
プロジェクト募集者が作成したプロジェクトの審査や管理、資金の送金等を行います。<br>
プロジェクト、リターン、活動報告、支援者、ユーザーや管理者同士のメッセージ等を管理（CRUD処理）できます。<br>
※詳細な仕様は下記 __ユーザーの仕様__ や __管理者の仕様__ で説明しています。<br>

__【PS（プロジェクトサポーター）リターン】__<br>
- リターンの中にはプロジェクトサポーター（以下「PS」という）リターンという特別なリターンがあります。<br>
これはプロジェクトを支援したユーザーが他のユーザーにそのプロジェクトを紹介、支援します。<br>
そして、プロジェクトを紹介した数をランキングで競い合い、そのランキングに応じてPSリターンの報酬を受け取る事ができます。
- PSはプロジェクトの紹介URLをSNSや知人で紹介し、紹介を受けたユーザーがそのリンクを踏んでから支援をした場合、ランキングの紹介人数に加算されます。<br>
__※開発当初は紹介したユーザーの支援総額で競い合う支援総額順のランキングも存在しましたが、現在は一旦保留との事でコメントアウトしています。（2022/3/5時点）__
- ランキングの何位までが報酬を受け取れるか、リターン内容等はプロジェクト実行者に委ねられています。

__【All or Nothing と All in方式】__<br>
- All or Nothing<br>
予め設定した期間内に目標金額を達成することで、プロジェクト実行者は期間終了日までに集まった支援額を獲得できます。<br>
期限以内（50日以下）に目標金額に達成しなかった場合はプロジェクトは不成立となり、支援金はユーザーに返金されます。
※現在は50日ですが、客先の要望で変わる可能性があります。（2022/3/5時点）
- All in<br>
目標金額に達成しなかったとしても、プロジェクト実行者は期間終了日までに集まった応援購入額を獲得できます。

__【決済機能について】__<br>
現在は決済機能としてGMO PAYMENTを実装しています。<br>
GMO PAYMENTを採用している理由は、All or Nothing方式でクラファンプロジェクトが目標金額に達しなかった場合、手数料無料で返金できるからです。（最長60日まで）<br>
GMO PAYMENTではクレジット決済日から最長60日まで「仮売上」として決済を計上できます。「仮売上」中は手数料無料で返金することができます。<br>
 「All or Nothing方式で目標金額に達成する」及び「All in方式」でプロジェクトが掲載終了となった場合にのみ、「本売上」として計上します。一度「本売上」にしてしまうと、決済を取り消す場合、手数料分は戻ってきません。

***
</details>



## ユーザーの仕様

<details>
<summary>本文を展開</summary>

### クラファンTOP画面

- ヘッダー部の「エントリー一覧」は人気クリエーターとのコラボに募集する為のページに遷移します。<br>
__※こちらはWordPressにて作成されており、弊社の方で各種修正に対応しています。__
- ヘッダー部の「プロジェクト一覧」はクラファンのページに遷移します。<br>
__※こちらはLaravelにて作成されており、フリーランスや業務委託の方に対応して頂く部分になります。__
- TOP画面最上部にあるLINEの友達追加部分は、プロジェクトを立ち上げたいインフルエンサーが気軽に運営と相談出来る様に設置されています。<br>
<img width="667" src="https://user-images.githubusercontent.com/66456130/159869917-f031f667-2870-4daa-b14f-bbaf79fd71e0.png">

- TOP画面の一番上に掲載されているプロジェクトはランダムで表示しています。
- 「ランキング」は支援者数順が多いプロジェクト順に並んでいます。また、「現在の支援者数」は同じユーザーが何度購入しても購入した回数分が人数としてカウントされます。<br>
※以前「現在の支援者数」は同じユーザーが複数回購入しても、支援者数を1人としてカウントしていました。<br>
そのロジックはProject.phpファイルのscopeGetWithPaymentsCountAndSumPriceメソッドにコメントアウトで残しています。（2022/3/24時点）
- 「新規プロジェクト」はプロジェクト開始日順に並んでいます。
- 「掲載終了プロジェクト」は2022年1月6日以前のプロジェクトは非表示としています。（客先より、ベータ版の時に作成したプロジェクトを一旦非表示にして欲しいとの要望があった）
- プロジェクトの達成率(目標額に対する支援総額)は、30%以下,30%,50%,90%,100%以上の5段階で色が変わっていきます。<br>
以前、All-In方式でプロジェクトの達成率に応じて、リターンの報酬内容を変えるとのことでした。しかし現状はその様な仕様ではない為、元の達成率の表示のみに戻す可能性はあります。（2022/3/24時点）
<img width="993" src="https://user-images.githubusercontent.com/66456130/159861200-c99e9539-0c5f-48ef-aa1b-cfa8538133d3.png">

- 「もっと見る」ボタンからプロジェクト検索画面に遷移出来ます。<br>
※以前はヘッダーに検索アイコンがあり、プロジェクト検索画面に遷移できましたが、ヘッダーの項目が増えて、現状は削除しています。<br>
今後掲載数が増えると検索機能を使用する頻度も増える為、再度検索アイコンを設置する可能性があります。（2022/3/5時点）
- カテゴリごとに検索も可能です。検索したいカテゴリをクリックしてください。<br>
<img width="891" src="https://user-images.githubusercontent.com/66456130/159858162-e24b4b52-8a5e-4442-9d50-443615fc71ac.png"><br>

- 下記画像の「よくある質問・ヘルプ」は未実装です。（2022/3/24時点）<br>
<img width="372" src="https://user-images.githubusercontent.com/66456130/159857557-c04ef6c8-cccd-4c7f-8557-3d42868b4822.png">

### プロジェクト検索画面

- プロジェクトのワード検索、ソート、絞り込みが可能です。
- 並び替えの「人気順」は現在「お気に入り数」の多い順にソートしています。今後修正の可能性はあります。（2022/3/5時点）

### プロジェクト詳細画面

- クラファンプロジェクトの内容、画像、動画、目標金額、終了日、リターン等の様々な情報を閲覧できます。
- 活動報告はプロジェクト募集者がプロジェクト進捗を投稿、発信する目的で使用します。<br>
※プロジェクトを支援したユーザーのみプロジェクトの「活動報告」を閲覧できます。
- 応援コメントはプロジェクト募集者に向けて応援メッセージを投稿する目的で使用します。<br>
※全てのユーザーが応援コメントを投稿出来ます。今後支援者しか投稿出来ないように仕様変更となる可能性もあります。
- プロジェクト支援後にPS解説画面（PSになる画面）やPSランキング画面に遷移する為のボタンが表示されるようになります。

### プロジェクト決済画面

- 購入に際し、ユーザー情報を入力します。リターンは各種複数購入が可能です。
- クレジット決済とコンビニ決済をが可能です。
- __開発初期に「Pay.JP」と「PayPay」で決済処理を実装していましたが、クライアントの要望により、「stripe」に変更しました。__<br>
__しかしその後、決済を仮売上からキャンセルできる期間が長い決済代行サービスに変更したいとの要望があり、最終的には「GMO PAYMENT」で実装しています。念の為、Pay.JP, PayPay, Stripeの処理は残しています。__
- クレジットカードのテストを実施したい場合は以下のサイトを参考にしてください。<br>
https://resource-sharing.co.jp/ec-sites-credit-card-test-number/

### PS解説画面（PSになる画面）

- プロジェクトを支援したユーザーのみ訪れる事が可能で、PSについての説明やPSになる為の招待リンクボタンがあります。
- __開発当初、PSと一般のユーザーで権限やできる事を分けたいとの要望があり、当ページに訪れたプロジェクト支援者を保存するPSテーブル（user_project_supported）を作成しました。現在の仕様では特段使用する事は無いですが、将来使用する可能性もある為、テーブルは残しています。（2022/3/5時点）__

### PSリターンランキング画面

- プロジェクトを支援したユーザーのみ訪れる事が可能です。PSとしてプロジェクトを紹介し、紹介したユーザーがプロジェクトを支援した人数のランキング（支援者数順）があります。<br>
__※概要のPSリターンで解説した通り、支援総額順のランキングはコメントアウト中。projectsテーブルのreward_by_total_amountカラムにあたります。カラムは残したままとしています。（2022/3/5時点）__

### プロフィール画面

- インフルエンサーの「出身地」は敢えて自由入力ができる入力フォームにしています。インフルエンサーが面白い出身地やネタとして書いてもいい様にする為です。（客先要望）

### 購入履歴 / PSになる 画面

- 購入したリターンの詳細が記載された履歴を確認できます。また「PSになる」、「PSランキングページ」へ遷移できます。
- オーダーIDは管理画面の「支援者(ファン)管理」で検索すると、該当する購入履歴が参照できます。また、そのIDを用いてGMO PAYMENTのダッシュボードで購入履歴を確認できます。

***

</details>



## インフルエンサーの仕様

<details>
<summary>本文を展開</summary>

### マイプロジェクト一覧画面

- プロジェクトを作成し、資金を募りたいユーザーが使用するページです。下書き中のプロジェクトや掲載中のプロジェクトなどが一覧表示されています。プロジェクト作成後は管理者（ファンリターン運営会社）へ審査してもらう為に申請する事ができます。
- プロジェクトの審査を申請する際、入力に不備があればアラートで表示されます。アラートで表示された箇所を修正すると、申請可能です。
- 対象のプロジェクトから編集、詳細画面に遷移できます。
- プロジェクトのステータスは以下の通りです。<br>
  - 【下書き中】<br>
    プロジェクトを作成して、申請していない状態。<br>
    <img width="322" src="https://user-images.githubusercontent.com/66456130/159872730-1f447851-3cc1-4a55-b1fd-54b9cea00341.png">
  - 【承認待ち】<br>
    プロジェクト申請し、承認されていない状態。<br>
    <img width="302" src="https://user-images.githubusercontent.com/66456130/159872733-fb14ec0b-b66d-4b0f-b29c-d9f187928b58.png">
  - 【差し戻し】<br>
    プロジェクトを申請したが、修正箇所がある為、再度編集と申請が必要。<br>
    <img width="316" src="https://user-images.githubusercontent.com/66456130/159872739-99984086-6f98-410a-90e1-ddbb2191eb3a.png">
  - 【公開前、公開中、公開終了】<br>
    プロジェクトを申請後、掲載許可が降りた状態。掲載開始日になると自動で「公開中」となり、終了すると「公開終了」に切り替わる。<br>
    __※管理画面はこのステータスではなく、一律で「掲載中」のステータスとなっている。__<br>
    __掲載開始日から終了日のプロジェクトのみ、TOP画面やプロジェクト検索画面に表示される。（2022/3/5時点）__<br>
    <img width="303" src="https://user-images.githubusercontent.com/66456130/159872723-c9988dc0-314d-4e0c-a12b-829560e7c69b.png">
  - 【掲載停止中】<br>
    プロジェクト募集者が何らかの理由でプロジェクトを継続できなくなった、または不適切なユーザーであった場合に緊急で使用します。<br>
    この状態はプロジェクトの公開が取り消され、編集、詳細の閲覧ができなくなります。<br>
    <img width="303" src="https://user-images.githubusercontent.com/66456130/159872737-ad432c51-13f9-4100-b8a2-e7dfbf2f18b3.png">

### マイプロジェクト編集画面

- クラファンで支援者を募る為にプロジェクトを作成、編集ができるページです。作成したプロジェクトはプレビューで確認する事ができます。
- フォームに入力すると非同期で保存されます。
- 各タブの仕様や注意点を以下の通りです。<br>
【目標設定】<br>
  - 掲載開始日を選択すると、掲載終了日は最大で50日までしか選択出来ません。
  - 掲載開始日は明日以降の日付を選択可能です。<br>
【概要】<br>
  - 概要文はリッチエディタで、画像や動画も挿入することができます。
【Top画像】<br>
  - 動画は1つだけ登録可能で、プロジェクト詳細のスライダー画像集の一番最初に表示されます。短縮URLも登録可能です。
【リターン】<br>
  - 「限定数」はグッズ等のリターンで個数の上限が必要になる場合に設定します。
  - 「お届け予定日」はプロジェクト終了月の翌月から選択可能です。
  - 「住所情報の取得」はリターンにTシャツやグッズ等が含まれる場合、支援したユーザーにグッズを発送する際に住所が必要となります。その場合はチェックを入れます。
【PSリターン】<br>
  - こちらの画面でプレビューを確認すると、PSランキングの画面が表示されます。
【本人確認】<br>
  - 銀行口座の入力フォームは別のページにある為、そちらで入力が必要です。

### 銀行口座登録画面

- こちらで登録した銀行口座情報はプロジェクトで調達した資金をインフルエンサーに振り込む際に使用します。<br>
また、登録した銀行口座情報はGMO PAYMENT側に保存されます。
  

### マイプロジェクト詳細画面

- プロジェクトの掲載ステータスによって扱える機能が異なります。<br>
【掲載中】<br>
<img width="409" src="https://user-images.githubusercontent.com/66456130/159873969-68b78626-8534-468c-bd0b-81d7a61a54ac.png">
【下書き中、承認待ち、差し戻し、掲載停止中】<br>
<img width="405" src="https://user-images.githubusercontent.com/66456130/159873921-91592a04-c3eb-41c0-ba5c-b50859f5deed.png"><br>

***
</details>



## 管理者の仕様

<details>
<summary>本文を展開</summary>

### プロジェクト管理画面

### プロジェクト管理

- ここではクラファンプロジェクトの閲覧、作成、編集、削除が可能です。そのほかにもプロジェクトの審査や掲載のステータス変更、プロジェクトの送金処理等を行います。<br>
  ※1 送金処理の方法については下記の __プロジェクト完了後の送金の流れ__ を参照下さい。<br>
  ※2 掲載ステータスについては __ユーザーの仕様__ 内にある __マイプロジェクト一覧画面__ を参照下さい。
- プロジェクトに関するリターン、活動報告、応援コメント、支援者管理も可能です。
- 「キュレーター」とは管理側のプロジェクト担当者です。プロジェクトの審査や送金、やりとり等を行う役割があります。

### プロジェクト完了後の送金の流れ

こちらを読む前に __概要__ の __決済機能について__ を参照願います。<br>

__【All or Nothing方式で目標金額達成後 もしくは All in方式でプロジェクト期間終了後の送金処理】__
1. プロジェクト終了→管理者に通知メール→通知メールのリンクをクリック→対象の「プロジェクト管理」画面に遷移する
   もしくは「プロジェクト管理」画面にて終了したプロジェクトを検索する<br>
![Image](https://user-images.githubusercontent.com/66456130/156914492-9907a607-a831-454b-b0e2-e721b8b8baa8.png)<br>
2. 画面右端にある「支援者（ファン）一覧」ボタンから「支援者（ファン）管理」画面へ<br>
![Image2](https://user-images.githubusercontent.com/66456130/156914493-c409090a-7315-4bb2-ae3a-c182dcfc8875.png)<br>
3. 上部にある「処理状況」のセレクトボックスを「仮売上」にすると、仮売上中の支払い状態で絞り込まれる
4. 「実売上計上」ボタンをクリックすると、支払いのステータスが「仮売上」→「実売上」に変化する<br>
![Image](https://user-images.githubusercontent.com/66456130/156880532-e2bc3ac1-fc2d-4622-9b70-54ccf15eaccf.png)<br>
※プロジェクトが掲載期間が終了していないにも関わらず、実売上に変更した場合以下のエラーメッセージが表示されます。<br>
![Image](https://user-images.githubusercontent.com/66456130/156914395-c73a49b6-f693-48fb-97e9-2a024e077a0f.png)<br>
5. プロジェクトIDが記載されているボタンをクリックし、先程の「プロジェクト管理」画面に戻る<br>
![Image](https://user-images.githubusercontent.com/66456130/156880867-3277fcf5-296e-46a9-a076-5ea5d6d5b396.png)<br>
6. 画面中央あたりに位置する「プロジェクト経費」を入力し、更新する<br>
![Image](https://user-images.githubusercontent.com/66456130/156881193-d71512d6-5ae6-484f-aeed-c893a5420218.png)<br>
7. 「送金実行する」ボタンにて、クラファンプロジェクト実行者に「プロジェクト経費」と「手数料(FR売上)」を差し引いた「合計支払い金額」が振り込まれる<br>
![Image](https://user-images.githubusercontent.com/66456130/156881234-749853dc-2d67-4577-9e9a-6c3d7cec5365.png)<br>
※プロジェクト実行者が銀行口座情報を入力していない場合、以下の様に表示されます<br>
![Image](https://user-images.githubusercontent.com/66456130/156914025-3d3a1f0f-bd2e-4cac-84c8-af4eae433fc6.png)<br>

__【All or Nothing方式で目標金額未達成 もしくは 何らかの理由でプロジェクトを終了後の返金処理】__
1. 上記の1〜3までは同様の流れ
2. 「売上キャンセル」（画面右端）ボタンをクリックすると、支払いのステータスが「仮売上」→「キャンセル」に変化する<br>
![Image](https://user-images.githubusercontent.com/66456130/156913925-40b78a0a-8ba4-482c-9d3b-88d7136506e2.png)

### DM一覧画面

- ユーザーとのDMが可能です。

### ユーザー管理画面

- ユーザーのCRUD処理が可能です。

### キュレーター管理画面

- キュレーターのCRUD処理が可能です。
- キュレーターとは管理側のプロジェクト担当者です。プロジェクトの審査や送金、やりとり等を行う役割があります。

### タグ管理画面

- プロジェクトに添付するタグのCRUD処理が可能です。

### 各種設定画面

- 管理画面のadminの名前、メールアドレス、パスワードを変更できます。

***
</details>


## メールの仕様

<details>
<summary>本文を展開</summary>

### 新規会員登録時

***
</details>